{% extends "layout_compose.html" %}

{% block body %}
<div class="ui fixed  transparent main inverted menu">
    <a class="item"  href = "{{ url_for('main.dash') }}">
        <i class=" green home icon"></i>{{ g.platform_setting.page_title }}
    </a>
    <!--
    <a class="item"  href = "{{ url_for('main.mainbbs') }}">
        <i class="chat outline icon"></i>BBS
    </a>
    -->
    {% if g.platform_setting.show_blog_link %}
    <a class="item"  href = "{{ url_for('main.mainblog') }}">
        <i class=" blue browser icon"></i>BLOG
    </a>
    {% endif %}
    <div class="ui dropdown item">
        <i class="red dashboard icon"></i>
        FUNCTION<i class="dropdown icon"></i>
        <div class="menu">
            {% if current_user.is_authenticated() %}
            {% if current_user.is_god() %}
            <a class="item"><i class="ordered list icon"></i>TODO LIST</a>
            <a class="active item" href = "{{ url_for('main.compose') }}"><i class="edit icon"></i>Write blog</a>
            {% endif %}
            {% endif %}
        </div>
    </div>
    <a class="item"  href = "{{ url_for('main.post_title', title = 'about') }}">
        <i class="teal book icon"></i>ABOUT
    </a>
    <div class="right menu">
        <!--<div class="item">
            <div class="ui small icon input">
                <input type="text" placeholder="搜索">
                <i class="search link icon"></i>
            </div>
        </div>-->
        <!--<div class="ui dropdown item">
            语言<i class="dropdown icon"></i>
            <div class="menu">
                <a class="item">英文</a>
                <a class="item">中文</a>
            </div>
        </div>-->
        <a class="item" href = "https://github.com/useyourfeelings">
            <i class = "github icon"></i>
        </a>
        <div class="ui dropdown item">
            <i class="user icon"></i>
            <div class="menu">
                {% if current_user.is_authenticated() %}
                <!--<a class="item">设置</a>-->
                {% if current_user.is_god() %}
                <a class="item" href = "{{ url_for('main.dashboard')}}">Admin</a>
                {% endif %}
                <a class="item" href = "{{ url_for('main.user', name = current_user.name )}}">Account</a>
                <a class="item" href = "{{ url_for('auth.logout') }}">Log out</a>
                {% else %}
                <a class="item" href = "{{ url_for('auth.login') }}">Log in</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="ui grid">
    {% if g.platform_setting.mode == 1 %}
    <div class="ui three wide column">
        <div class="ui tiny top attached header">BBS TREE</div>
        <div class="bbstree-segment">
            <div class="ui attached segment">
                <ul id="bbstree" class="ztree bbstree"></ul>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="ui ten wide column">
        <div id = "thread"></div>
    </div>
</div>

{% include "bbs_post_editor.html" %}

{% endblock %}

{% block script %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename = 'highlight/styles/monokai_sublime.css') }}" />
<script type="text/javascript" src="{{ url_for('static', filename = 'highlight/highlight.pack.js') }}"></script>
{% if g.platform_setting.mode == 1 %}
<script type="text/javascript" src="{{ url_for('static', filename='zTree_v3/js/jquery.ztree.all-3.5.js') }}"></script>
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='zTree_v3/css/zTreeStyle/zTreeStyle.css') }}">
<script type="text/javascript" src="{{ url_for('static', filename = 'beartoday/bbstree.js') }}"></script>
{% endif %}

<script type="text/javascript">
    
    var can_reply = {{ can_reply }};
    var post_id = {{ post_id }};
    var parent_post_id = {{ parent_post_id }};
    var ancestor_post_id = {{ ancestor_post_id }};
    var user_is_author = {{ user_is_author }};
    
    var MODE_REPLY = "new";
    var MODE_EDIT = "edit";
    var editor_mode = MODE_REPLY;
    
    var post_title = "";
    var post_body = "";
    
    $('#markdown_main').split({orientation:'horizontal', limit:220, onDragEnd:onSplitterDargEnd});
    $('#help').popup();
    
    function savepostover(data, status)
    {
        if(status == 'success' && data == "OK")
        {
            //alert("succeeded");
            $('#mdeditor-modal').sidebar('hide');
            if(editor_mode == MODE_EDIT)
                alert("OK");
            updatethreaddata();
        }
        else
        {
            alert("failed");
        }
    }

    $('#mdeditor-submit').bind('click', function(){
        $.post("/savepost", {original_post:post_id, editor_mode:editor_mode, title:$("#mdeditor-title").val(), body:mdi.getWholeText()/*previewHtml*/, owner_bbs:0, owner_blog:0, parent_post_id:parent_post_id, ancestor_post_id:ancestor_post_id, is_comment:1}, savepostover);
    });

    $('#mdeditor-close').bind('click', function(){
        $('#mdeditor-modal').sidebar('hide');
    });
    
    function buildComments(posts){
        var comments = '';
        if(!posts || posts.length == 0)
            return '';
        var i;
        for(i = 0; i < posts.length; ++ i){
            comments +=
            '<div class="comment post-comment">\
                <div class="ui segment post-comments-segment">\
                    <a><img class="rounded ui image bbs-title-avatar" src ="http://bear.today/avatar/' + posts[i].author.avatar_hash + '?s=24">\</a>\
                    <a href="/user/' + posts[i].author.name + '">' + posts[i].author.name + '</a> '
                    + posts[i].post.post_time + ' | ' 
                    + posts[i].post.like_count + '<a class="like"><i class="thumbs up outline icon"></i></a> | '
                    + posts[i].post.dislike_count + '<a class="dislike"><i class="thumbs down outline icon"></i></a>\
                    <div class="ui tiny green inverted button reply-button" id =' + posts[i].post.id +'>\
                        reply\
                    </div>'
                     + converter.makeHtml(posts[i].post.body) +
                '</div>';
                
                if(posts[i].child_posts.length != 0){
                    comments += '\
                    <div class="ui comments post-comments">';
                    comments += buildComments(posts[i].child_posts);
                    comments +=
                    '</div>';
                }
            comments += '\
            </div>';
        }
        
        return comments;
    }
    
    function getthreadover(data, status){
        if(status == "success"){
            var thread = JSON.parse(data);
            
            post_title = thread.post.title;
            post_body = thread.post.body;
            
            edit_button_string = "";
            if(user_is_author)
                edit_button_string = '<div class="ui tiny red button editbutton" id ="post-edit-button">edit</div>';
            
            var threadstring = '\
                    <div class="ui stacked segment">\
                        <div class="ui"></div>\
                                <img class="rounded ui image bbs-title-avatar" src ="http://bear.today/avatar/' + thread.author.avatar_hash + '?s=48">'
                                + '<a href="/user/' + thread.author.name + '">' + thread.author.name + '</a> | '
                                + thread.post.post_time + ' | '
                                + thread.post.view_count + '<i class="unhide icon"></i> | '
                                + thread.post.comment_count + '<i class="comment outline icon"></i> | '
                                + thread.post.like_count + '<a class="like"><i class="thumbs up outline icon"></i></a> | '
                                + thread.post.dislike_count + '<a class="dislike"><i class="thumbs down outline icon"></i></a>\
                                <div class="ui tiny green button reply-button" id = ' + thread.post.id + '>\
                                    reply\
                                </div>' + edit_button_string + 
                            '<div class="ui top right green attached label">\
                                <a href="/post/t/' + thread.post.title + '">permanent link</a>\
                            </div><br><br><h2>' + thread.post.title + '</h2>\
                        </div>\
                    <div class="ui stacked segment">\
                            <div class="BT-post"><div>' + converter.makeHtml(thread.post.body) + '</div></div>\
                        </div>';
                        
                        if(thread.child_posts.length != 0){
                            threadstring +='<div class="ui threaded comments post-comments">';
                            threadstring += buildComments(thread.child_posts);
                            threadstring += '</div>';
                        }
            threadstring +='</div>';
            
            $("#thread").html(threadstring);
            
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
            
            $("#mdeditor-modal").sidebar({overlay: true});
            
            $(".reply-button").click(function(){
                if(!can_reply){
                    alert("register and confirm your account first");
                    return;
                }
                $('#mdeditor-mode').html('REPLY');
                $('#mdeditor-modal').sidebar('show');
                editor_mode = MODE_REPLY;
                parent_post_id = this.id;
            });
                
            $("#post-edit-button").click(function(){
                $('#mdeditor-modal').sidebar('show');
                editor_mode = MODE_EDIT;
                parent_post_id = 0;// no use
                
                $('#mdeditor-mode').html('EDIT');
                $("#mdeditor-title").val(post_title);
                mdi.setWholeText(post_body);
                //$("#mdeditor-body").html(post_title);
            });
        }
        else{
            alert("ERROR!");
        }
    }
    
    function updatethreaddata(){
        $.post("/getthread", {post_id:post_id}, getthreadover);
    }
    
    updatethreaddata();
    
    {% if g.platform_setting.mode == 1 %}
    bbstree = new BBSTREE({{ owner_bbs }});
    bbstree.getbbstree();
    {% endif %}
    
</script>
{% if g.platform_setting.mode == 1 %}
<style type="text/css">
.ztree li span.button.add {margin-left:2px; margin-right: -1px; background-position:-144px 0; vertical-align:top; *vertical-align:middle}
</style>
{% endif %}
{% endblock %}

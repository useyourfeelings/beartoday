{% extends "layout_compose.html" %}

{% block body %}
<div class="ui fixed  transparent main inverted menu">
    <a class="item"  href = "{{ url_for('main.dash') }}">
        <i class=" green home icon"></i>{{ g.platform_setting.page_title }}
    </a>
    <a class="item"  href = "{{ url_for('main.mainbbs') }}">
        <i class="chat outline icon"></i>BBS
    </a>
    {% if g.platform_setting.show_blog_link %}
    <a class="item"  href = "{{ url_for('main.mainblog') }}">
        <i class=" blue browser icon"></i>BLOG
    </a>
    {% endif %}
    <div class="ui dropdown item">
        <i class="red dashboard icon"></i>
        FUNCTION<i class="dropdown icon"></i>
        <div class="menu">
            {% if current_user.is_authenticated() %}
            {% if current_user.is_god() %}
            <a class="item"><i class="ordered list icon"></i>TODO LIST</a>
            <a class="active item" href = "{{ url_for('main.compose') }}"><i class="edit icon"></i>Write blog</a>
            {% endif %}
            {% endif %}
        </div>
    </div>
    <div class="right menu">
        <!--<div class="item">
            <div class="ui small icon input">
                <input type="text" placeholder="搜索">
                <i class="search link icon"></i>
            </div>
        </div>-->
        <!--<div class="ui dropdown item">
            语言<i class="dropdown icon"></i>
            <div class="menu">
                <a class="item">英文</a>
                <a class="item">中文</a>
            </div>
        </div>-->
        <a class="item"  href = "{{ url_for('main.post_title', title = 'about') }}">
            <i class="teal book icon"></i>ABOUT
        </a>
        <div class="ui dropdown item">
            <i class="user icon"></i>
            <div class="menu">
                {% if current_user.is_authenticated() %}
                <!--<a class="item">设置</a>-->
                {% if current_user.is_god() %}
                <a class="item" href = "{{ url_for('main.dashboard')}}">Admin</a>
                {% endif %}
                <a class="item" href = "{{ url_for('main.user', name = current_user.name )}}">Account</a>
                <a class="item" href = "{{ url_for('auth.logout') }}">Log out</a>
                {% else %}
                <a class="item" href = "{{ url_for('auth.login') }}">Log in</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="ui grid" id = "thread">
    <!--<div class="ui ten wide column">
        <div class="ui stacked segment">
            <div class="ui red ribbon label"></div>
                by <a href=""></a> |
                <i class="unhide icon"></i> |
                <i class="comment outline icon"></i> |
                <a class="like"><i class="thumbs up outline icon"></i></a> |
                <a class="dislike"><i class="thumbs down outline icon"></i></a>
            <div class="ui top right green attached label">
                <a href="">permanent link</a>
            </div>
            <div class="BT-post"><div></div></div>
        </div>
        <div class="ui horizontal divider">
            <i class="smile icon"></i>
        </div>
        <div class="ui mini green circular button commentbutton" >
            <i class="comment outline icon"></i>reply
        </div>
        <br>
        <br>
        <div class="ui threaded comments">
        </div>
    </div>-->
</div>

<div class="ui very wide right sidebar" id="commentmodal">
    <div class="ui fixed transparent main inverted menu">
        <div class="ui item">
            <div class="ui left small icon input">
                <input type="text" placeholder="title" id="title">
                <i class="edit icon"></i>
            </div>
        </div>
        <div class="ui icon item">
            <div class="ui tiny dropdown button">
                <i class="wrench icon"></i>
                <div class="menu">
                    <div class="item" id="undo"><i class="undo icon"></i>undo</div>
                    <div class="item" id="redo"><i class="repeat icon"></i>redo</div>
                    <div class="item" id="dobold"><i class="bold icon"></i>bold</div>
                    <!--<div class="ui tiny button"><i class="align center icon"></i></div>
                    <div class="ui tiny button"><i class="align left icon"></i></div>
                    <div class="ui tiny button"><i class="align right icon"></i></div>-->
                    <div class="item" id="addurl"><i class="url icon"></i>addurl</div>
                    <div class="item" id="addimg"><i class="photo icon"></i>addimg</div>
                    <!--<div class="ui tiny button"><i class="code icon"></i></div>-->

                    <div class="item" id="newdoc"><i class="file outline icon"></i>newdoc</div>
                    <!--<div class="ui tiny button"><i class="save icon"></i></div>
                    <div class="ui tiny button"><i class="open folder outline icon"></i></div>-->

                    <div class="item" id="exporthtml">export as HTML</div>
                    <div class="item" id="exportmd">export as MD</div>
                </div>
            </div>
            <div class="ui tiny positive button" id="submit">publish</div>
            <div class="ui tiny red button"  id="close">close</div>
        </div>
    </div>
    <div>
        <div id = "markdown_main">
            <div id="markdown_editor">USE YOUR FEELINGS
            </div>
            <div id = "markdown_preview">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename = 'highlight/styles/monokai_sublime.css') }}" />
<script type="text/javascript" src="{{ url_for('static', filename = 'highlight/highlight.pack.js') }}"></script>
<style type="text/css" media="screen">
    #markdown_editor { 
        position: absolute;
        top: 0px;
        right: 0;
        bottom: 0;
        left: 0;
        overflow-y:hidden;
    }
    #markdown_main { 
        position: absolute;
        top: 42px;
        right: 0;
        bottom: 0;
        left: 0;
        height:100% - 42px;
        overflow: hidden;
    }
</style>
<script type="text/javascript" src="{{ url_for('static', filename = 'js/beartoday_editor.js') }}"></script>
<script type="text/javascript">
    //monokai_sublime tomorrow pojoaque
    
    var can_reply = {{ can_reply }};
    var post_id = {{ post_id }};
    var parent_post_id = {{ parent_post_id }};
    var ancestor_post_id = {{ ancestor_post_id }};
    
    $('#markdown_main').split({orientation:'horizontal', limit:220, onDragEnd:onSplitterDargEnd});
    $('#help').popup();
    
    function savepostover(data, status)
    {
        if(status == 'success' && data == "OK")
        {
            alert("succeeded");
            $('#commentmodal').sidebar('toggle');
            updatethreaddata();
        }
        else
        {
            alert("failed");
        }
    }

    $('#submit').bind('click', function(){
        $.post("/savepost", {title:'', body:previewHtml, owner_bbs:0, owner_blog:0, parent_post_id:parent_post_id, ancestor_post_id:ancestor_post_id, is_comment:1}, savepostover);
    });

    $('#close').bind('click', function(){
        $('#commentmodal').sidebar('toggle');
    });
    
    function buildComments(posts){
        var comments = '';
        if(!posts || posts.length == 0)
            return '';
        var i;
        for(i = 0; i < posts.length; ++ i){
            comments +=
            '<div class="comment">\
                <div class="ui segment">\
                    <a><i class="user icon"></i></a>\
                    <a href="/user/' + posts[i].author.name + '">' + posts[i].author.name + '</a> '
                    + posts[i].post.post_time + ' | ' 
                    + posts[i].post.like_count + '<a class="like"><i class="thumbs up outline icon"></i></a> | '
                    + posts[i].post.dislike_count + '<a class="dislike"><i class="thumbs down outline icon"></i></a>\
                    <div class="ui mini circular green inverted button commentbutton" id =' + posts[i].post.id +'>\
                        reply\
                    </div>'
                    + posts[i].post.body +
                '</div>\
                <div class="comments">';
                
                comments += buildComments(posts[i].child_posts);
                
            comments +=
                '</div>\
            </div>';
        }
        
        return comments;
    }
    
    function getthreadover(data, status){
        if(status == "success"){
            var thread = JSON.parse(data);
            
            var threadstring = '\
                <div class="ui twelve wide column">\
                    <div class="ui stacked segment">\
                        <div class="ui red ribbon label">' + thread.post.post_time + '</div>\
                                by <a href="/user/' + thread.author.name + ')">' + thread.author.name + '</a> | '
                                + thread.post.view_count + '<i class="unhide icon"></i> | '
                                + thread.post.comment_count + '<i class="comment outline icon"></i> | '
                                + thread.post.like_count + '<a class="like"><i class="thumbs up outline icon"></i></a> | '
                                + thread.post.dislike_count + '<a class="dislike"><i class="thumbs down outline icon"></i></a>\
                                <div class="ui mini green circular button commentbutton" id = ' + thread.post.id + '>\
                                    reply\
                                </div>\
                            <div class="ui top right green attached label">\
                                <a href="/post/t/' + thread.post.title + '">permanent link</a>\
                            </div><br><br>\
                            <div class="BT-post"><div>' + thread.post.body + '</div></div>\
                        </div>\
                        <div class="ui horizontal divider">\
                            <i class="smile icon"></i>\
                        </div>\
                        <div class="ui threaded comments">';
                        
            threadstring += buildComments(thread.child_posts);
            threadstring += '</div>\
            </div>';
            
            $("#thread").html(threadstring);
            
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
            
            //$("#commentmodal").modal('setting', 'closable', false);
            $("#commentmodal").sidebar({overlay: true});
            
            $(".commentbutton").click(function(){
                if(!can_reply){
                    alert("register and confirm your account first");
                    return;
                }
                $('#commentmodal').sidebar('toggle');
                parent_post_id = this.id;
            });
        }
        else{
            alert("ERROR!");
        }
    }
    
    function updatethreaddata(){
        $.post("/getthread", {post_id:post_id}, getthreadover);
    }
    
    updatethreaddata();
    
</script>
{% endblock %}